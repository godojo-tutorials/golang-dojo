---
/**
 * TableOfContents - Компонент оглавления для главной страницы
 * Стиль learn.javascript.ru:
 * - Блоки с заголовками
 * - Плоский список топиков с нумерацией X.Y
 *
 * Supports two block types:
 * - flat: true blocks have topics directly (no modules)
 * - blocks with modules have nested structure
 */

import tocData from '@/data/toc.json';
import { t, type Lang } from '@/utils/i18n';

interface Props {
  lang?: Lang;
}

interface Topic {
  slug: string;
  title: string;
  number?: string;
}

interface Module {
  id: string;
  title: string;
  topics: Topic[];
}

interface Block {
  id: string;
  title: string;
  number?: number;
  flat?: boolean;
  topics?: Topic[];
  modules?: Module[];
}

interface TocData {
  [key: string]: { blocks: Block[] };
}

const { lang = 'ru' } = Astro.props;
const data = (tocData as TocData)[lang] || { blocks: [] };
const blocks: Block[] = data.blocks || [];
const labels = t(lang).toc;
---

<div class="toc-container">
  {blocks.map((block) => {
    // Use block.number from curriculum (preserves position even with unpublished topics)
    const sectionNumber = block.number || 1;

    const items: { number: string; title: string; slug: string }[] = [];

    // Handle flat blocks (topics directly in block)
    if (block.flat && block.topics) {
      block.topics.forEach((topic) => {
        items.push({
          number: topic.number || '0',
          title: topic.title,
          slug: topic.slug,
        });
      });
    }
    // Handle blocks with modules
    else if (block.modules) {
      block.modules.forEach((module) => {
        module.topics.forEach((topic) => {
          items.push({
            number: topic.number || '0',
            title: topic.title,
            slug: topic.slug,
          });
        });
      });
    }

    return (
      <section class="toc-section">
        <div class="toc-section-header">
          <span class="toc-section-number">{sectionNumber}</span>
          <h2 class="toc-section-title">{block.title}</h2>
        </div>

        <div class="toc-items">
          {items.map((item) => (
            <a href={`/${lang}/${item.slug}/`} class="toc-item">
              <span class="toc-item-number">{item.number}</span>
              <span class="toc-item-title">{item.title}</span>
            </a>
          ))}
        </div>
      </section>
    );
  })}

  {blocks.length === 0 && (
    <p class="toc-empty">{labels.empty}</p>
  )}
</div>
